<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de Alumnos del Equipo Flex Body</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: url('./fondo.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      min-height: 100vh;
    }
    #bg-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(5px);
      z-index: 0;
      pointer-events: none;
    }
    .max-w-7xl { position: relative; z-index: 1; }
  </style>
</head>
<body class="text-slate-800">
  <div id="bg-overlay"></div>
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6 text-white drop-shadow-md">
      <h1 class="text-3xl font-bold">Lista de Alumnos del Equipo Flex Body</h1>
      <p class="text-sm text-slate-100">Registro de alumnos, horarios fijos, días de la semana, profes y pagos.</p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-1 bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-2">Agregar / editar alumno</h2>
        <form id="studentForm" class="space-y-3">
          <input type="hidden" id="studentId" />

          <label class="block">
            <span class="text-sm">Nombre completo</span>
            <input id="name" class="mt-1 block w-full border rounded p-2" required />
          </label>

          <label class="block">
            <span class="text-sm">WhatsApp del alumno</span>
            <input id="studentPhone" type="text" class="mt-1 block w-full border rounded p-2" placeholder="+595..." />
          </label>

          <label class="block">
            <span class="text-sm">Fecha de inicio</span>
            <input id="startDate" type="date" class="mt-1 block w-full border rounded p-2" />
          </label>

          <label class="block">
            <span class="text-sm">Fecha de próximo pago</span>
            <input id="dueDate" type="date" class="mt-1 block w-full border rounded p-2" />
          </label>

          <div>
            <span class="text-sm font-semibold">Días de clase</span>
            <div class="flex flex-wrap gap-2 mt-2">
              <label class="inline-flex items-center"><input type="checkbox" value="Lun" class="dayCheckbox mr-2"/>Lun</label>
              <label class="inline-flex items-center"><input type="checkbox" value="Mar" class="dayCheckbox mr-2"/>Mar</label>
              <label class="inline-flex items-center"><input type="checkbox" value="Mié" class="dayCheckbox mr-2"/>Mié</label>
              <label class="inline-flex items-center"><input type="checkbox" value="Jue" class="dayCheckbox mr-2"/>Jue</label>
              <label class="inline-flex items-center"><input type="checkbox" value="Vie" class="dayCheckbox mr-2"/>Vie</label>
            </div>
          </div>

          <label class="block mt-2">
            <span class="text-sm">Horario fijo</span>
            <input type="time" id="fixedTime" class="mt-1 block w-full border rounded p-2" />
          </label>

          <label class="block mt-2">
            <span class="text-sm">Profesor</span>
            <input type="text" id="fixedProf" class="mt-1 block w-full border rounded p-2" placeholder="Nombre del profe" />
          </label>

          <div class="flex gap-2 mt-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar</button>
            <button type="button" id="clearBtn" class="border px-4 py-2 rounded">Limpiar</button>
          </div>
        </form>
      </div>

      <div class="md:col-span-2 bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-semibold">Alumnos registrados</h2>
          <input id="search" placeholder="Buscar por nombre" class="border p-2 rounded" />
        </div>

        <div id="tableWrap" class="overflow-x-auto">
          <table class="w-full table-auto">
            <thead class="text-left text-sm text-slate-600">
              <tr>
                <th class="p-2">Nombre</th>
                <th class="p-2">Días / Hora / Profe</th>
                <th class="p-2">Próx. pago</th>
                <th class="p-2">Estado</th>
                <th class="p-2">WhatsApp</th>
                <th class="p-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="studentsTbody" class="text-sm"></tbody>
          </table>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">Cuadrícula semanal de asistencia por profesor y hora</h3>
          <div class="overflow-x-auto" id="scheduleContainer"></div>
        </div>
      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-100 drop-shadow">Ahora conectado a Firebase Firestore.</footer>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfPoyEFqZzvhmGLTKLLOZ9R2xr6n14_08",
    authDomain: "proyectoflexbody.firebaseapp.com",
    projectId: "proyectoflexbody",
    storageBucket: "proyectoflexbody.firebasestorage.app",
    messagingSenderId: "794622847955",
    appId: "1:794622847955:web:b0b8e1ebb22ede0c8b5d26",
    measurementId: "G-5J3SWHST35"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const studentsCol = collection(db, "students");

  const allStudents = [];

  async function saveStudent(student) {
    if (student.id) await updateDoc(doc(db, "students", student.id), student);
    else await addDoc(studentsCol, student);
  }

  async function deleteStudentFirebase(id) {
    if (!confirm("¿Seguro quieres eliminar este alumno?")) return;
    await deleteDoc(doc(db, "students", id));
  }
  window.deleteStudentFirebase = deleteStudentFirebase;

  window.editStudent = function (s) {
    document.getElementById("studentId").value = s.id;
    document.getElementById("name").value = s.name || "";
    document.getElementById("studentPhone").value = s.studentPhone || "";
    document.getElementById("startDate").value = s.startDate || "";
    document.getElementById("dueDate").value = s.dueDate || "";
    document.getElementById("fixedTime").value = s.time || "";
    document.getElementById("fixedProf").value = s.prof || "";
    document.querySelectorAll(".dayCheckbox").forEach(cb => {
      cb.checked = (s.days || []).includes(cb.value);
    });
    document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  window.renewStudent = async function (id, currentDate) {
    if (!currentDate) return;
    const fecha = new Date(currentDate);
    const diaOriginal = fecha.getDate();
    fecha.setMonth(fecha.getMonth() + 1);
    if (fecha.getDate() !== diaOriginal) fecha.setDate(0);
    const nuevaStr = fecha.toISOString().split("T")[0];
    await updateDoc(doc(db, "students", id), { dueDate: nuevaStr });
  };

  function render(students) {
    const tbody = document.getElementById('studentsTbody');
    tbody.innerHTML = '';
    const search = document.getElementById('search').value.toLowerCase();

    students.filter(s => !search || s.name.toLowerCase().includes(search))
    .forEach(s => {
      const classStr = (s.days || []).map(d => `${d} ${s.time} (${s.prof})`).join('<br/>');
      const waLink = s.studentPhone ? 
        `https://wa.me/${s.studentPhone.replace(/\D/g,'')}?text=${encodeURIComponent(
          'Muy buenas, paso a recordarle que su fecha de vencimiento de Flex Body es ' + (s.dueDate || '')
        )}` : '#';

      let estado = '-';
      const hoy = new Date().toISOString().split("T")[0];
      let extraBtns = "";
      if (s.dueDate) {
        if (s.dueDate < hoy) extraBtns += `<button onclick="renewStudent('${s.id}','${s.dueDate}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs ml-1">Renovar</button>`;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2 align-top">${s.name}</td>
        <td class="p-2 align-top">${classStr}</td>
        <td class="p-2 align-top">${s.dueDate || '-'}</td>
        <td class="p-2 align-top">
          ${s.dueDate < hoy ? '<span class="text-red-600 font-semibold">Vencido</span>' :
            s.dueDate === hoy ? '<span class="text-orange-500 font-semibold">Vence hoy</span>' :
            '<span class="text-green-600 font-semibold">Al día</span>'
          }
        </td>
        <td class="p-2 align-top text-center">
          <a href="${waLink}" target="_blank" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Notificar</a>
        </td>
        <td class="p-2 align-top text-center">
          <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs" onclick='editStudent(${JSON.stringify(s)})'>Editar</button>
          ${extraBtns}
          <button class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-1" onclick="deleteStudentFirebase('${s.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderScheduleGrid(students) {
    const days = ['Lun','Mar','Mié','Jue','Vie'];
    const container = document.getElementById('scheduleContainer');
    container.innerHTML = '';
    const gridMap = {};
    students.forEach(s => {
      if (!s.prof || !s.time) return;
      const key = `${s.prof}||${s.time}`;
      if (!gridMap[key]) gridMap[key] = [];
      gridMap[key].push(s);
    });
    Object.keys(gridMap).forEach(key => {
      const [prof, timeBase] = key.split("||");
      let profStudents = gridMap[key];
      profStudents.sort((a,b)=>a.name.localeCompare(b.name,'es',{sensitivity:'base'}));
      const table = document.createElement('table');
      table.className = 'w-full border table-auto text-sm mb-6';
      const dayCounts = {};
      days.forEach(d=>{dayCounts[d]=profStudents.filter(s=>(s.days||[]).includes(d)).length;});
      table.innerHTML = `
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-1">Alumno</th>
            ${days.map(d=>`<th class="border p-1">${d} <br><span class="text-xs">(${dayCounts[d]}/9)</span></th>`).join('')}
          </tr>
        </thead>`;
      const tbodyEl = document.createElement('tbody');
      profStudents.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border p-1 font-semibold">${s.name}</td>
          ${days.map(d=>{
            const hasClass = (s.days||[]).includes(d);
            let bgColor = hasClass ? 'bg-green-200' : '';
            if(dayCounts[d]>=9) bgColor='bg-red-400 text-white';
            return `<td class="border p-1 text-xs ${bgColor}">${hasClass?s.name:''}</td>`;
          }).join('')}
        `;
        tbodyEl.appendChild(tr);
      });
      table.appendChild(tbodyEl);
      const profTitle = document.createElement('h4');
      profTitle.className='font-semibold mt-4 mb-2';
      profTitle.textContent=`Profesor: ${prof} — Horario: ${timeBase}`;
      container.appendChild(profTitle);
      container.appendChild(table);
    });
  }

  onSnapshot(studentsCol, snapshot=>{
    allStudents.length=0;
    snapshot.forEach(docu=>allStudents.push({id:docu.id,...docu.data()}));
    render(allStudents);
    renderScheduleGrid(allStudents);
  });

  document.getElementById("studentForm").addEventListener("submit", async ev=>{
    ev.preventDefault();
    const student = {
      id: document.getElementById('studentId').value,
      name: document.getElementById('name').value.trim(),
      studentPhone: document.getElementById('studentPhone').value.trim(),
      startDate: document.getElementById('startDate').value,
      dueDate: document.getElementById('dueDate').value,
      days: Array.from(document.querySelectorAll('.dayCheckbox:checked')).map(c=>c.value),
      time: document.getElementById('fixedTime').value,
      prof: document.getElementById('fixedProf').value.trim()
    };
    await saveStudent(student);
    ev.target.reset();
    document.getElementById('studentId').value='';
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    document.getElementById('studentForm').reset();
    document.getElementById('studentId').value='';
  });

  document.getElementById('search').addEventListener('input', ()=>render(allStudents));

</script>
</body>
</html>
